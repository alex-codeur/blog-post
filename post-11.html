<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <title>Blog</title>
</head>

<body>
    <div class="container">
        <h1>Node JS MongoDB: Connecter votre API √† une base de donn√©e MongoDB</h1>

        <h4>Table des mati√®res</h4>

        <ul>
            <li>Pourquoi utiliser MongoDB avec une API Node JS ?
            </li>
            <li>Les choix techniques avant de d√©marrer</li>
            <li>MongoDB en local ou dans le cloud ?</li>
            <li>Quelle librairie utiliser pour connecter MongoDB √† notre API Node JS ?
            </li>
            <li>Connexion de MongoDB √† notre API Node JS</li>
            <li>Importer nos donn√©es dans MongoDB</li>
            <li>Refactoriser le code de l'API Node JS MongoDB</li>
            <li>R√©cup√©rer les donn√©es de la base MongoDB</li>
            <li>Les nuances de l'update</li>
            <li>√Ä vous de jouer !</li>
            <li>Besoin d'aide pour avancer ?</li>
            <li>Retrouvez le code source de l'API sur Github</li>
            <li>La suite de l'API NodeJS MongoDB</li>
        </ul>

        <p>Dans le poste pr√©c√©dent, nous avons vu comment cr√©er une Node JS API en simulant des donn√©es depuis des
            fichiers JSON. Or dans la vraie vie, une API va √™tre connect√©e √† une (voir plusieurs) base de donn√©es afin
            de pouvoir faire son travail.</p>

        <p>MongoDB est une technologie de base de donn√©es NoSQL qui est tr√®s populaire dans l'√©cosyst√®me JavaScript.
            Cette comp√©tence est souvent recherch√©e chez les d√©veloppeurs NodeJS. Dans ce post, nous allons reprendre
            l'exemple de code pr√©c√©dent et connecter une base de donn√©es MongoDB √† notre API NodeJS.</p>

        <h3>Pourquoi utiliser MongoDB avec une API Node JS ?</h3>

        <ol>
            <li>
                <h5>Une comp√©tence tr√®s demand√©e</h5>
                Cette demande est probablement n√©e d'une tendance autour de la stack MEAN ou MERN. Toujours est-il
                qu'aujourd'hui de nombreux projets en entreprise utilisent la stack Node JS et MongoDB.
            </li>
            <li>
                <h5>Une solution pratique
                </h5>
                MongoDB fonctionne en stockant vos donn√©es sous forme d'objets BSON, tr√®s similaire √† l'objet JSON avec
                lesquels les d√©veloppeurs JavaScript sont tr√®s familiers.
            </li>
        </ol>

        <h3>Les choix techniques avant de d√©marrer</h3>

        <h4>MongoDB en local ou dans le cloud ?</h4>

        <p>Comme vous le savez peut-√™tre, il existe deux fa√ßons d'avoir acc√®s √† une base de donn√©es MongoDB Soit en
            l'installant localement sur votre PC ou votre mac, soit en utilisant un service cloud comme MongoDB Atlas.
        </p>

        <h3>Quelle librairie utiliser pour connecter MongoDB √† notre API Node JS ?</h3>

        <p>Pour pouvoir vous connecter √† votre base de donn√©es MongoDB, l√† aussi, deux choix s'offrent √† vous. Utiliser
            la librairie officielle de MongoDB ou utiliser la librairie Mongoose.</p>

        <p>MongoDB Client vous permet d'√™tre au plus pr√®s de votre base de donn√©es et utiliser les fonctions natives de
            MongoDB comme si vous √©tiez connect√©s sur un shell Mongo.</p>

        <p>Mongoose est une surcouche qui vient apporter la possibilit√© d'imposer un Schema, soit une structure
            obligatoire, √† votre mod√®le de donn√©es. C'est √©galement l'option la plus populaire.</p>

        <p>Dans notre cas nous allons utiliser Mongodb Client et l'installer via le gestionnaire de paquets npm.</p>

        <h3>Connexion de MongoDB √† notre API Node JS</h3>

        <p>La premi√®re √©tape est d'ajouter le package mongodb √† notre projet. Je ne vous explique pas la commande (mais
            n'oubliez pas de vous mettre dans le r√©pertoire du projet dans votre terminal).</p>

        <div class="jumbotron">
            npm install mongodb
        </div>

        <p>Suivant la documentation de Mongodb Client, voici √† quoi ressemblerait la connexion √† notre base de donn√©es.
        </p>

        <div class="jumbotron">
            <p>const express = require('express')</p>
            <p>const app = express()</p>
            <p>const parkings = require('./parkings.json')</p>
            <p>/**
                * Import MongoClient & connexion √† la DB
                */</p>
            <p>const MongoClient = require('mongodb').MongoClient;</p>
            <p>const url = 'mongodb://localhost:27017';</p>
            <p>const dbName = 'parkingApi';</p>
            <p>let db</p>
            <p>MongoClient.connect(url, function(err, client) {</p>
            <p>console.log("Connected successfully to server");</p>
            <p>db = client.db(dbName);</p>
            <p>});</p>
            <p>app.use(express.json())</p>
            <p>app.get('/parkings', (req,res) => {</p>
            <p>res.status(200).json(parkings)</p>
            <p>})</p>
            <p>app.get('/parkings/:id', (req,res) => {</p>
            <p>const id = parseInt(req.params.id)</p>
            <p>const parking = parkings.find(parking => parking.id === id)</p>
            <p>res.status(200).json(parking)</p>
            <p>})</p>
            <p>app.post('/parkings', (req,res) => {</p>
            <p>parkings.push(req.body)</p>
            <p>res.status(200).json(parkings)</p>
            <p>})</p>
            <p>app.put('/parkings/:id', (req,res) => {</p>
            <p>const id = parseInt(req.params.id)</p>
            <p>let parking = parkings.find(parking => parking.id === id)</p>

            <p> parking.name =req.body.name,</p>
            <p>parking.city =req.body.city,</p>
            <p> parking.type =req.body.type,</p>
            <p>res.status(200).json(parking)</p>
            <p>app.delete('/parkings/:id', (req,res) => {</p>
            <p>const id = parseInt(req.params.id)</p>
            <p>let parking = parkings.find(parking => parking.id === id)</p>
            <p>parkings.splice(parkings.indexOf(parking),1)</p>
            <p>res.status(200).json(parkings)</p>
            <p>})</p>
            <p>app.listen(8080, () => {</p>
            <p>console.log("Serveur √† l'√©coute")</p>
            <p>})</p>
        </div>

        <p>Avant de relancer mon serveur, je vais me connecter au Shell Mongo et √©valuer les connexions actives au
            serveur MongoDB.</p>

        <p>Je vois dans l'objet current que pour l'instant il n'y a qu'une seule connexion en cours. Je vais maintenant
            lancer mon serveur Node et v√©rifier √† nouveau le nombre de connexion.</p>

        <p>√Ä en croire mon terminal, la callback de ma fonction MongoClient.connect() a bien √©t√© appel√©, ce qui me
            laisse croire que la connexion √† la base de donn√©es a bien fonctionn√©. Je vais v√©rifier √† nouveau sur le
            shell:</p>

        <p>On voit que cette fois il y a 2 connexions courantes, celle du Shell et celle de l'API. On peut √™tre confiant
            sur le fait que notre API est bien connect√©e √† la base de donn√©es.</p>

        <div class="jumbotron">
            Attention toutefois au message de la callback "Connected successfully to server" car il peut √™tre trompeur.
            Si je cherche √† provoquer une erreur de connexion en modifiant l'URL de connexion √† mongodb://localhost:21
            au lieu de mongodb://localhost:27017, mon terminal va clairement m'alerter comme quoi il y a une erreur,
            mais il va passer dans la callback et ex√©cuter l'instruction console.log("Connected successfully to
            server"); alors que la connexion n'est pas √©tablie.
        </div>

        <h3>Importer nos donn√©es dans MongoDB</h3>

        <p>Jusque-l√†, nous utilisions des donn√©es dans un fichier JSON plut√¥t qu'une base de donn√©es. Pour continuer
            notre cas pratique, nous allons maintenant importer ces donn√©es dans MongoDB.</p>

        <p>Pour vous simplifier la t√¢che, vous pouvez utiliser un client graphique MongoDB tel que Mongo Compass ou si
            vous √™tes √† l'aise avec les requ√™tes mongo, utiliser le shell directement. C'est l'option que nous allons
            choisir ici</p>

        <div class="jumbotron">
            mongoimport --jsonArray --db parkingApi --collection parkings --file parkings.json
        </div>

        <p>V√©rifions maintenant que les donn√©es sont bien dans notre base de donn√©es via le shell:</p>

        <h3>Refactoriser le code de l'API Node JS MongoDB</h3>

        <p>Nous avons la certitude que notre API se connecte bien √† notre base de donn√©es et que celle-ci contient les
            √©l√©ments pour que notre API continue de fonctionner. Nous allons maintenant r√©√©crire le code de notre API
            Node JS MongoDB pour utiliser cette nouvelle base de donn√©es.</p>

        <h4>R√©cup√©rer les donn√©es de la base MongoDB</h4>

        <p>Comme on l'a vu dans notre requ√™te dans le shell, la requ√™te suivante va nous permettre d'afficher la liste
            de tous nos parkings:</p>

        <div class="jumbotron">db.parkings.find()</div>

        <p>Je vais donc adapter le code correspondant √† ma route GET / afin d'ex√©cuter cette requ√™te:</p>

        <div class="jumbotron">
            <p>app.get('/parkings', (req,res) => {</p>
            <p>db.collection('parkings').find({}).toArray(function(err, docs) {</p>
            <p>if (err) {</p>
            <p>console.log(err)</p>
            <p>throw err</p>
            <p>}</p>
            <p>res.status(200).json(docs)</p>
            <p>})</p>
        </div>

        <p>Ce code vient de la documentation de Mongodb. Il reprend l'objet db qui correspond √† la connexion √† la base
            de donn√©es Mongo et nous permet d'utiliser ses requ√™tes. Dans notre cas, nous avons utilis√© la requ√™te find
            sans passer de filtres de telle sorte √† ce qu'il nous retourne tous les objets pr√©sents en base.</p>

        <div class="jumbotron">
            Le code sollicitant une op√©ration en base de donn√©es est asynchrone
            Dans la mesure o√π une requ√™te interrogeant une base de donn√©es va prendre plus que quelques millisecondes,
            l'event loop NodeJS va sous-traiter cette op√©ration dans une queue √† part. Lorsque la base de donn√©es aura
            r√©pondu √† la requ√™te, au prochain passage de la boucle d'√©v√®nement Node JS, ex√©cutera la fonction en
            callback, qui contient l'ordre de r√©ponse.
        </div>

        <p>L'utilisation des callbacks n'est plus tr√®s appr√©ci√©e dans l'√©cosyst√®me JavaScript. Depuis l'arriv√©e de
            l'ES6, les promises sont privil√©gi√©es. Modifions notre code afin qu'il soit plus "acceptable"</p>

        <div class="jumbotron">
            <p>app.get('/parkings', (req,res) => {</p>
            <p>db.collection('parkings').find({}).toArray()</p>
            <p>.then(docs => res.status(200).json(docs))</p>
            <p>.catch(err => {</p>
            <p>console.log(err)</p>
            <p>throw err</p>
            <p>})</p>
            <p>})</p>
        </div>

        <p>Depuis l'ES8, une troisi√®me syntaxe est propos√©e pour faire ses requ√™tes asynchrones. La syntaxe async/await
            offre une syntaxe tr√®s lisible pour les requ√™tes asynchrones. Voici √† quoi √ßa ressemble:</p>

        <div class="jumbotron">
            <p>app.get('/parkings', async (req,res) => {</p>
            <p>try {</p>
            <p>const docs = await db.collection('parkings').find({}).toArray()</p>
            <p>res.status(200).json(docs)</p>
            <p>} catch (err) {</p>
            <p>console.log(err)</p>
            <p>throw err</p>
            <p>}</p>
            <p>})</p>
        </div>

        <div class="jumbotron">La syntaxe async/await est simplement du sucre syntaxique autour de l'utilisation des
            Promises. Les deux pratiques sont retrouv√©es en entreprise et il est important de savoir les manipuler.
        </div>

        <p>R√©cup√©rer un seul parking depuis notre API Node JS MongoDB</p>

        <p>Nous avons pu r√©cup√©rer l'ensemble des parkings, maintenant nous pouvons utiliser la m√™me requ√™te et la
            modifier l√©g√®rement pour ne r√©cup√©rer qu'un seul objet de la base de donn√©es.</p>

        <div class="jumbotron">
            <p>app.get('/parkings/:id', async (req,res) => {</p>
            <p>const id = parseInt(req.params.id)</p>
            <p>try {</p>
            <p>const docs = await db.collection('parkings').find({id}).toArray()</p>
            <p>res.status(200).json(docs)</p>
            <p>} catch (err) {</p>
            <p>console.log(err)</p>
            <p>throw err</p>
            <p>}</p>
            <p>})</p>
        </div>

        <h4>Les nuances de l'update</h4>

        <p>Dans l'exercice pr√©c√©dent, nous avons tr√®s bri√®vement abord√© le sujet de la modification d'un objet dans
            notre API. Nous utilisions la m√©thode PUT pour venir remplacer l'int√©gralit√© de l'objet √† chaque fois.</p>

        <p>Or il existe deux approches √† la mise √† jour d'un objet dans une API CRUD:</p>

        <ul>
            <li>La modification, o√π vous venez modifier uniquement un ou plusieurs champs de votre objet</li>
            <li>Le remplacement; o√π vous √©crasez l'int√©gralit√© des donn√©es de l'objet par les nouvelles donn√©es</li>
        </ul>

        <p>MongoDB reproduit ces 2 approches en vous offrant deux m√©thodes, updateOne et replaceOne, pour r√©pondre √† ces
            besoins.</p>

        <p>Parfois vous n'aurez pas l'int√©gralit√© des donn√©es de votre objet lorsque vous souhaiterez le mettre √† jour.
            Dans ce cas il faudra utiliser la m√©thode PATCH au lieu de PUT.</p>

        <p>Ajoutez une route PATCH /parkings/:id √† votre API</p>

        <h3>√Ä vous de jouer !</h3>

        <p>√Ä la diff√©rence du guide pr√©c√©dent, celui-ci va √™tre volontairement moins exhaustif. Le but √©tant de vous
            faire manipuler MongoDB et vous laisser avancer jusqu'√† trouver comment r√©aliser vos premi√®res op√©rations
            MongoDB.</p>

        <p>Si vous ne l'avez pas d√©j√† lu, je vous invite √† consulter la page d√©crivant les requ√™tes CRUD en mongodb dont
            vous aurez besoin pour terminer ce cas pratique.</p>

        <p>Pour terminer votre API NodeJS MongoDB, vous devez modifier le code correspondant aux routes POST /parkings,
            PUT /parkings/:id et DELETE /parkings/:id pour qu'il interagisse avec votre base de donn√©es MongoDB.</p>

        <p>Si vous voulez aller plus loin, vous pouvez importer le fichier reservations.json dans votre base de donn√©es,
            dans une collection reservations et modifier le code correspondant aux requ√™tes de r√©servations pour avoir
            une API NodeJS MongoDB compl√®te.</p>

        <p>Une fois que vous aurez termin√©, vous pourrez effacer les fichiers parkings.json et reservations.json du
            repository</p>

        <div class="jumbotron">
            üéÅ BONUS
            Si tu regardes bien, tu verras que le code de connexion √† la base de donn√©es est aussi con√ßu avec une
            callback. Essaye de le refactorer de telle sorte qu'il utilise une Promise au lieu d'une callback.
        </div>

        <h4>Besoin d'aide pour avancer ?</h4>

        <h5>Je ne vois pas comment terminer l'exercice ?</h5>

        <p>Les 3 fonctionnalit√©s restantes sont l'ajout d'un nouveau parking, la modification d'un parking existant et
            la suppression d'un parking.</p>

        <p>Je te sugg√®re de commencer par l'ajout d'un nouveau parking. Regarde dans la page des query mongo comment
            ajouter un √©l√©ment √† la base de donn√©es. Inspire-toi du code pr√©sent dans les routes GET et modifie la
            requ√™te mongoDB pour qu'elle fasse ce que tu veux.</p>

        <p>Le code pour effacer un parking est √©galement tr√®s similaire √† celui de l'ajout d'un parking. Trouve la bonne
            m√©thode dans la doc de mongoDB et applique-la dans la bonne route.</p>

        <p>Enfin, les deux m√©thodes de modifications (PUT et PATCH) sont un petit peu plus complexes. L√† aussi tu
            trouveras facilement des exemples sur la documentation.</p>

        <h5>Pourquoi est-ce qu'on a "id" et "_id" pour chaque objet parking?</h5>

        <p>Dans notre premier guide, nous avions besoin d'un id pour pouvoir identifier et manipuler chaque objet
            parking ind√©pendamment. C'est pourquoi je l'ai ajout√© en dur dans notre objet JSON.</p>

        <p>Lors de l'import de notre fichier JSON, MongoDB a cr√©√© par d√©faut _id, rendant le champ id redondant. Pour
            continuer votre API Node JS MongoDB, trois options s'offrent √† vous:</p>

        <ul>
            <li>Ignorer le champ _id et continuer √† cr√©er manuellement le champ id ,en tant que nombre qui s'incr√©mente
                pour chaque objet. Vous pourriez cr√©er une fonction qui viendrait automatiquement reprendre et
                incr√©menter l'id</li>
            <li>Remplacer le champ id par le champ _id, cette solution est la plus simple mais vous allez vous retrouver
                avec des URL peu lisibles comme /parkings/5f48a58c9f93aa6fe9c865cc</li>
            <li>Cr√©er un champ slug qui serait une cha√Æne de caract√®res unique reprenant le nom de votre parking, tout
                en minuscule et sans espaces. Par exemple : "parking-pas-cher-roissy" ou "parking-vinci-lille-europe".
                L'URL est bien plus lisible mais risque de devenir plus longue. Dans ce cas, il faudra pr√©voir la
                cr√©ation de ce slug √† partir du champ nom dans la m√©thode appel√©e lors de la cr√©ation d'un nouveau
                parking.</li>
        </ul>

        <h3>Retrouvez le code source de l'API sur Github</h3>

        <p>Tu pourras retrouver le code source de notre API Node JS MongoDB si tu souhaites comparer ton code au mien.
        </p>

        <p>Si tu as le repository sur ton poste, n'oublie pas de changer de branche pour aller sur la branche
            part2/mongodb</p>

        <h3>La suite de l'API NodeJS MongoDB</h3>

        <p>Cette s√©rie de mise en pratique ne s'arr√™tera pas l√† ! Au programme du prochain √©pisode on va revoir
            l'architecture de notre API et mettre en place le pattern d'architecture N-tier !</p>
    </div>
</body>

</html>